{% extends 'baseLogged.html.twig' %}

{% block stylesheets %}
    {{parent()}}
{% endblock %}

{% block breadcrumb %}
    {% include 'breadcrumb.html.twig' with {'modulos': data.modulo} %}
{% endblock %}

{% block principal %}

    <form action="{% if permissao.permissao > 1  %} /tickets/form {% else %} javascript:void(0); {% endif  %}" method="post" role="form" class="main-form p-bottom-40" enctype="multipart/form-data">

        <div class="panel panel-card">

            <input type="hidden" name="category" value="S">

            {% if ticket.id is defined %}
                <input type="hidden" name="id" value="{{ticket.id}}">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label>Status*</label>
                            <select name="status_id" class="form-control" data-myrules="required" {% if ticket.billed == 'ON' %} disabled="disabled" {% endif %}>
                                {% for stat in status %}
                                    <option value="{{stat.id}}" {% if ticket.last_status.id == stat.id %} selected="selected" {% endif %}>{{stat.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label>Consultor Responsável</label>
                            <select name="user_internal_id" class="form-control" disabled="disabled">
                                <option></option>
                                {% for adm in admin_users %}
                                    <option value="{{adm.id}}" {% if ticket.user_internal_id == adm.id %} selected="selected" {% endif %}>{{adm.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="row">

                <div class="col-lg-6">

                    <div class="form-group">
                        <label>Projeto/Produto*</label>
                        <select name="project_id" class="form-control" data-myrules="required">
                            <option></option>
                            {% for company in companies %}
                                <option value="{{company.id}}" disabled="true">{{company.name}}</option>
                                {% if company.projects|length > 0 %}
                                    {% for project in company.projects %}
                                        <option value="{{project.id}}" {% if ticket.project_id is defined and ticket.project_id == project.id %} selected="selected" {% endif %}>{{company.name}} &nbsp;&rarr; {{project.name}}</option>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Título*</label>
                        <input type="text" name="title" class="form-control" placeholder="Informe o título" value="{% if ticket.title is defined %}{{ticket.title}}{% endif %}" data-myrules="required">
                    </div>

                    {% if ticket.id is defined %}
                        <div class="form-group">
                            <label>Solicitante</label>
                            <input type="text" class="form-control" disabled="disabled" value="{{ticket.user_name}}">
                        </div>
                    {% endif %}
                </div>

                <div class="col-lg-6">

                    <div class="form-group">
                        <label>Tipo*</label>
                        <select name="type_id" class="form-control" data-myrules="required">
                            <option value=""></option>
                            {% for type in types %}
                                <option value="{{type.id}}" {% if ticket is defined and ticket.type_id == type.id %} selected="selected" {% endif %}>{{type.name}}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Prioridade*</label>
                        <select name="priority_id" class="form-control" data-myrules="required">
                            <option value=""></option>
                            {% for priority in priorities %}
                                <option value="{{priority.id}}" {% if ticket is defined and ticket.priority_id == priority.id %} selected="selected" {% endif %}>{{priority.name}}</option>
                            {% endfor %}
                        </select>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="form-group">
                        <label>Descrição*</label>
                        <textarea id="description" name="description" class="form-control redactor-ticket" style="height: 200px; resize: none;">{{ticket.description|raw}}</textarea>
                        <p class="help-block">Pressione o Shift + Enter para linhas sem espaçamento.</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
		    {% if ticket.id is not defined and permissao.permissao > 1 or ticket.user_id == usuario_logado.id or is_admin == 'ON' %}
                    	<button type="submit" class="btn btn-default btn-success margin-r-15"><i class="fa fa-check"></i> {% if ticket.id is defined %} Editar {% else %} Adicionar {% endif %}</button>
                    {% endif  %}
		     <a href="/tickets" class="font-13">Cancelar</a>
                </div>
            </div>

        </div>

    </form>

    {% if ticket.id is defined %}
        <div class="panel panel-card">
            <div class="row">
                <div class="col-lg-12">
                    <h3>Arquivos</h3>
                    <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th width="530">Descrição</th>
                            <th width="350">Arquivo</th>
                            <th width="150">Data</th>
                            <th>Tamanho</th>
                            <th width="80"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                            <tr>
                                <td>{{file.description}}</td>
                                <td>{{file.name}}</td>
                                <td>{{file.created_at_br}}</td>
                                <td>{{file.size}}</td>
                                <td align="right">
                                    <a href="/tickets/download/{{file.link}}" target="_blank" class="btn btn-default btn-xs" title="Download"><i class="fa fa-download"></i></a>
                                    {% if file.can_delete %}
                                        <a href="javascript:void(0);" class="btn btn-danger btn-xs btn-delete-file-modal" data-id="{{file.id}}" data-ticket-id="{{file.ticket_id}}" data-name="{{file.name}}" title="Excluir"><i class="fa fa-trash-o"></i></a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="5" align="center">Nenhum arquivo.</tr>
                        {% endfor %}
                        <tr>
                            <td colspan="4"></td>
                            <td align="right">
                                {% if ticket.add_file == true and ticket.last_status.id != 6 %}
                                    <a href="javascript:void(0);" data-ticket-id="{{ticket.id}}" class="btn btn-success btn-xs btn-add-file" title="Adicionar Arquivo"><i class="fa fa-plus"></i> Adicionar</a>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <h3>Atendimentos</h3>
                    <form action="/tickets/print/{{ticket.id}}" method="post" class="form-print" target="_blank">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th width="90">Data</th>
                                    <th width="60">Início</th>
                                    <th width="60">Fim</th>
                                    {# <th width="60">Total</th> #}
                                    <th width="170">Consultor</th>
                                    <th width="180">Tipo</th>
                                    <th>Descrição</th>
                                    <th width="150">Status</th>
                                    <th width="90">
                                        <a style="display:none" href="javascript:void(0);" class="btn btn-default btn-xs btn-print-calleds" title="Imprimir Atendimentos Selecionados"><i class="fa fa-print"></i> Imprimir</a>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in calleds %}
                                    <tr>
                                        <td>{{row.date}}</td>
                                        <td>{{row.hour_start}}</td>
                                        <td>{{row.hour_finish}}</td>
                                        {# <td>{{row.hour_total}}</td> #}
                                        <td>{{row.user_name}}</td>
                                        <td>{{row.hour_name}}</td>
                                        <td>{{row.description|raw}} {% if row.closed_value == 'ON' %} <br>Valor Fechado: R$ {{row.hour_value}} {% endif %}</td>
                                        <td><small>{% if row.status == 'EM_ATENDIMENTO' %} Em Atendimento {% elseif row.status == 'CONCLUIDO' %} Concluído {% else %} Faturado em {{row.billed_at|date('d/m/Y')}} {% if row.num_nf != null %} Nro. NF: {{row.num_nf}} {% endif %} {% endif %}</small></td>
                                        <td align="right">
                                            {% if is_admin == 'ON' %}
                                                <input type="checkbox" name="calleds[]" value="{{row.id}}" title="Clique para Imprimir" class="chk-print-item">
                                            {% endif %}
                                            {% if row.can_delete %}
                                                <a href="javascript:void(0);" class="btn btn-default btn-xs btn-edit-modal" data-ticket-id="{{row.ticket_id}}" data-id="{{row.id}}" data-date="{{row.date}}" data-hour-start="{{row.hour_start}}" data-hour-finish="{{row.hour_finish}}" data-description="{{row.description|raw|e}}" data-hour-id="{{row.hour_id}}" data-closed-value="{{row.closed_value}}" data-hour-value="{{row.hour_value}}" data-status="{{row.status}}" title="Editar"><i class="fa fa-pencil"></i></a>
                                                <a href="javascript:void(0);" class="btn btn-danger btn-xs btn-delete-modal" data-id="{{row.id}}" title="Excluir"><i class="fa fa-trash-o"></i></a>
                                            {% endif %}

                                        </td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="8" align="center">Nenhum atendimento.</tr>
                                {% endfor %}
                                <tr>
                                    <td>{% if total_hours != null %}<strong>Horas</strong>{% endif %}</td>
                                    <td colspan="3">{% if total_hours != null %}<strong>{{total_hours}}</strong>{% endif %}</td>
                                    <td colspan="3"></td>
                                    <td>
                                        {% if ticket.add_called == true and ticket.last_status.id != 6 %}
                                            <a href="javascript:void(0);" data-id="{{ticket.id}}" class="btn btn-success btn-xs btn-add-called" title="Adicionar Atendimento"><i class="fa fa-plus"></i> Adicionar</a>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <h3>Despesas</h3>
                    <form action="/tickets/expense/print/{{ticket.id}}" method="post" class="form-print-expense" target="_blank">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th width="100">Data</th>
                                    <th width="90">Cobrado</th>
                                    <th width="190">Tipo</th>
                                    <th width="200">Consultor</th>
                                    <th width="100">Valor</th>
                                    <th>Descrição</th>
                                    <th width="90">
                                        <a style="display:none" href="javascript:void(0);" class="btn btn-default btn-xs btn-print-expense" title="Imprimir recibo das despesas selecionadas"><i class="fa fa-print"></i> Imprimir</a>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for exp in expenses %}
                                    {% if exp.list == true %}
                                        <tr>
                                            <td>{{exp.date_at}}</td>
                                            <td>{% if exp.company_billing == 'ON' %} Sim {% else %} Não {% endif %}</td>
                                            <td>{{exp.type}}</td>
                                            <td>{{exp.user}}</td>
                                            <td>{{exp.value}}</td>
                                            <td>{{exp.description|raw}}</td>
                                            <td align="right">
                                                {# <input type="checkbox" name="expenses[]" value="{{exp.id}}" title="Clique para Imprimir" class="chk-expense-item"> #}
                                                {% if exp.can_delete %}
                                                    <a href="javascript:void(0);" class="btn btn-default btn-xs btn-edit-expense" data-id="{{exp.id}}" data-ticket-id="{{exp.ticket_id}}" data-date="{{exp.date_at}}" data-expense-id="{{exp.expense_id}}" data-description="{{exp.description|raw}}" data-value="{{exp.val}}" data-company-billing="{{exp.company_billing}}" title="Editar"><i class="fa fa-pencil"></i></a>
                                                    <a href="javascript:void(0);" class="btn btn-danger btn-xs btn-delete-expense" data-id="{{exp.id}}" title="Excluir"><i class="fa fa-trash-o"></i></a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% else %}
                                    <tr><td colspan="7" align="center">Nenhuma despesa.</tr>
                                {% endfor %}
                                <tr>
                                    <td colspan="2">{% if total_value_expenses != null %}<strong>Total das despesas</strong>{% endif %}</td>
                                    <td colspan="2">{% if total_value_expenses != null %}<strong>{{total_value_expenses}}</strong>{% endif %}</td>
                                    <td colspan="2"></td>
                                    <td>
                                        {% if ticket.add_expense == true and ticket.last_status.id != 6 %}
                                            <a href="javascript:void(0);" data-ticket-id="{{ticket.id}}" class="btn btn-success btn-xs btn-add-expense" title="Adicionar Despesa"><i class="fa fa-plus"></i> Adicionar</a>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <h3>Histórico</h3>
                    <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th width="160">Data</th>
                            <th width="220">Status</th>
                            <th>Descrição</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for status in history %}
                            <tr>
                                <td>{{status.created_at_br}}</td>
                                <td>{{status.name}}</td>
                                <td>{{status.description}}</td>
                            </tr>
                        {% else %}
                            <tr><td colspan="3" align="center">Nenhum histórico.</tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    {% endif %}

  {# MODAL DE INSERÇÃO DE ARQUIVO NO CHAMADO #}
    <div class="modal fade modal-file" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/tickets/add/file" method="post" class="form-ticket-file" enctype="multipart/form-data">
                    <input type="hidden" name="ticket_id" value="{{row.id}}">
                    <div class="modal-body">
                        <h4>Arquivo - Chamado <strong></strong></h4>
                        <div class="form-group m-top-15">
                            <input type="text" name="description" class="form-control" placeholder="Descrição" data-myrules="required">
                        </div>
                        <div class="form-group m-top-15">
                            <input id="fileinput" type="file" name="file" data-myrules="required" data-allowed-file-extensions='["csv", "jpg", "png", "jpeg", "gif", "bmp", "pdf", "docx", "doc", "odt", "xls", "xlsx", "txt", "ods"]'>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <span class="success m-right-20 fcolor-398439"></span>
                        <span class="notification m-right-20 fcolor-b13125"></span>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary btn-success btn-file-submit" data-loading-text="Enviando...">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {# EOF - MODAL DE INSERÇÃO/EDIÇÃO DE ARQUIVO NO CHAMADO #}
    <div class="modal fade modal-delete-file" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    Confirma a exclusão do arquivo <strong></strong>?
                </div>
                <div class="modal-footer">
                    <form action="/tickets/delete/file" method="post" class="form-delete-file">
                        <input type="hidden" name="id" value="">
                        <input type="hidden" name="ticket_id" value="{{ticket.id}}">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary btn-submit-delete-file btn-success" data-loading-text="Processando...">Confirmar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% include 'ticket/modal-add-called.html.twig' %}

{% endblock %}

{% block javascripts %}
    {{parent()}}
    <script src="/libs/bootstrap-uploadfile/js/fileinput.min.js" type="text/javascript"></script>
    <script src="/libs/bootstrap-uploadfile/js/fileinput_locale_pt-BR.js" type="text/javascript"></script>
    <script>
        $(function(){
            $("#fileinput").fileinput({
                showCaption: false,
                language: 'pt-BR',
                overwriteInitial: false,
                maxFileSize: 10000,
                maxFilesNum: 1,
                showUpload: false,
                dropZoneEnabled: false,
                slugCallback: function(filename) {
                    $('.kv-file-upload').remove();
                        return filename.replace('(', '_').replace(']', '_');
                    }
            });
        });
    </script>
{% endblock %}
